{% extends 'project/base.html' %}

{% load static %}
{% load trips_tags %}
{% load widget_tweaks %}

{% block stylesheet %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/trips/style.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/project/sidebar_menu.css' %}" />
{% endblock stylesheet %}

{% block javascript_bottom %}
  {# add/edit gear #}
  <script>
    // Enable hover response for buttons
    $("button.link-button").hover(function() {
      $(this).find("i.link-button").toggleClass('dark-hover');
    });

    // Handler for "Add Gear" link. Adds text entry fields.
    $("#add-gear").on("click", function() {
      $(this).parent().before($("#row-template").html());

      // Enable hover response for new buttons
      $(this).parent().prev().find("button.link-button").hover(function() {
        $(this).find("i.link-button").toggleClass('dark-hover');
      });

      // Create handlers for save and cancel button
      // Passing csrf token with data due to CSRF_COOKIE_HTTPONLY
      $(".add-item-form").on("submit", function(event) {
        event.preventDefault();
        var data = $(this).serialize();
        ajax_create_item(data);
      });
    });

    // POST to Item
    function ajax_create_item(data) {
      $.ajax({
        url: "{% url 'trips:add_item' %}",
        data,
        dataType: "json",
        type: "POST",
        success: function(data) {
          console.log("Successfully added item")
          if (data["msg"]) {
            post_message(data["msg"]);
          }
        },
        error: function(data, textStatus, jqXHR) {
          post_message("Your gear was not able to be added. Please make sure you included a description")
        },
      });
    }

    // Display success message after adding model instance.
    function post_message(msg) {
      var message_container = $("#message-container");
      message_container.empty();
      message_container.append('<li class="alert alert-success ajax-alert">' + msg + '</li>');
      $(".ajax-alert").slideDown("fast");
    }
  </script>

  {# sidebar slider #}
  <script src="{% static 'js/project/sidebar_menu.js' %}"></script>
{% endblock javascript_bottom %}

{% block below_nav %}
  {% include "project/sidebar_button.html" %}
{% endblock below_nav %}

{% block content %}
  {# sidebar #}
  {% include "trips/sidebar_menu.html" %}

  {# main content #}
  <div id="content">

    <div class="banner-logo">
      <h1>Gear</h1>
    </div>

    {# Table of users and emergency contacts #}
    <div class="x-scroll">
      <table id="gear-table" class="table table-header-rotated table-striped table-hover table-striped-column">
        <thead>
          <tr>
            <th></th> {# column for item descriptions. I.e. row headers #}

            {# Following headers are rotated #}
            {% for trip_member in trip_members %}
              <th class="header rotate-45"><div><span>{{ trip_member.member.get_short_name }}</span></div></th>
            {% endfor %}

          </tr>
        </thead>
        <tbody>
          {% for item in trip_items %}
            <tr>
              <th class="row-header no-wrap">
                <div class="button-group">
                  <button class="btn link-button"><i class="fa fa-pencil fa-lg link-button" aria-hidden="false"></i></button>
                  <button class="btn link-button"><i class="fa fa-trash fa-lg link-button" aria-hidden="false"></i></button>
                </div>

                {{ item.description }}
              </th>

              {% for trip_member in trip_members %}
                <td>{{ item.itemowner_set|get_quantity:trip_member.member }}</td>
              {% endfor %}

            </tr>
          {% endfor %}

          {# final row holds add-new button #}
          <tr>
            <th id="add-gear" colspan="2">
              <button class="btn link-button"><i class="fa fa-plus-circle fa-lg link-button" aria-hidden="true"></i> Add Gear</button>
            </th>
          </tr>

        </tbody>
      </table>

      {# hidden template row. Added to table when #add-gear is pressed #}
      <script type="text/template" id="row-template">
        <tr>
          <th class="itemform-element no-wrap">
            <form class="add-item-form">
              {% csrf_token %}
              <div class="button-group">
                <button class="btn link-button"><i class="fa fa-lock fa-lg link-button" aria-hidden="false"></i></button>
                <button class="btn link-button"><i class="fa fa-times fa-lg link-button" aria-hidden="false"></i></button>
              </div>
              {{ form.description|add_class:"item-description" }}
              {{ form.trip_id }}
            </form>
          </th>
          {% for trip_member in trip_members %}
            <td class="itemform-element">{{ form.quantity|add_class:"item-quantity" }}</td>
          {% endfor %}
        </tr>
      </script>

    </div>
  </div>
{% endblock content %}
